# 審査機序図生成スキル

建築基準法の条文から審査機序図（kijo diagram）JSONを生成する。

## トリガー

- 「機序図を作成」「機序図を生成」
- 「法○条の機序図」「令○条の機序図」
- 条文指定での機序図作成リクエスト

## スキーマ

**必ず `schemas/kijo-diagram.schema.json` を読み込んでから作業すること。**

## 審査機序図とは

審査機序図は、建築確認申請における計画案件の法適合判定における**情報処理のメカニズム**を表現するための図式。

### 目的
- 建築計画の法適合判定メカニズムと設計情報要件の明確化
- 審査ソフトウェアの機能要件定義

### 対象
- 個別の建築計画の設計内容を規制する条文（「規制文」）
- 「〜ならない。」で終わる文のうち、建築計画の立地条件や設計内容に関わるもの

## 作業フロー

### STEP 1: スキーマ読み込み
```
schemas/kijo-diagram.schema.json を読む
```

### STEP 2: 条文取得
法令MCP（`law`）を使用して対象条文の全文を取得。

```
law.get_article(law_id="325AC0000000201", article="43", paragraph="1")
```

### STEP 3: 法文構造分析

1. **規制文特定**: 「〜しなければならない」「〜してはならない」を特定
2. **適合命題変換**:
   - 「Aでなければならない」→「Aである」
   - 「Bであれば Aでなければならない」→「Bではない OR Aである」
3. **ただし書き分析**: 例外条件をAND/OR構造で表現
4. **各号展開**: 「各号のいずれか」は個別に取得して構造化
5. **別表参照**: 「別表第一」等の参照があれば別表内容も取得

### STEP 4: JSON生成

出力先: `data/diagrams/{法令ID}/A{条}_P{項}_kijo.json`

**ファイル命名規則:**
- 機序図: `A{条}_P{項}_kijo.json`（例: `A22_P1_kijo.json`）
- 枝番あり: `A{条}_{枝番}_P{項}_kijo.json`（例: `A20_3_P2_kijo.json`）

## 構成要素

### ページタイトル
1枚の審査機序図が表す情報処理の概要を表現。

### [情報]ノード - 長方形
審査に必要なデータや判定結果を表す。**主体とその性質**で構成される。

- **主体**: 建築計画における物理的な物（壁、柱など）や幾何学的形状概念（床面積算定領域、敷地境界線など）
- **性質**: 主体がもつ属性、他の主体との関係性

### [処理]ノード - 角丸長方形
情報を変換・判定する処理を表す。

### エッジ（矢印）
- **[情報]→[処理]**: 情報が処理に必要なインプット
- **[処理]→[情報]**: 情報が処理によって導出されたアウトプット

## [情報]の種類（property_type）

| 種類 | 説明 | 例 |
|------|------|-----|
| `proposition` | 命題真偽 - 真か偽かが判定可能な事実 | 技術基準を満たすか否か |
| `classification` | 区分情報 - 既定の区分のいずれか | 用途地域、建物用途コード |
| `numeric` | 数値 - 整数値または実数値 | 延べ面積、高さ |
| `geometric_point` | 幾何学概念（点） | 天空率の計測点、開口部の中心点 |
| `geometric_direction` | 幾何学概念（方向） | 真北 |
| `geometric_line` | 幾何学概念（線形状） | 避難動線、建物と地盤面の接する線 |
| `geometric_surface` | 幾何学概念（面形状） | 隣地境界 |
| `geometric_solid` | 幾何学概念（ソリッド） | 柱/壁の形状、延焼のおそれのある部分 |
| `set_definition` | 集合定義 - 関係にある他の主体の特定 | 階に属する外壁の集合 |
| `visual` | 視認情報 - 人による総合的認識・判断が必要 | 断面詳細図による告示仕様適合判断 |

## [処理]の種類（process_type）

| 種類 | 説明 | 表示 |
|------|------|------|
| `mechanical` | 機械的処理 - 自動化可能な論理演算や計算（視認情報は接続不可） | 水色（cyan） |
| `human_judgment` | 人の認識/判断を要する処理 | オレンジ色（orange） |
| `undefined_input` | 入力情報不定処理 - 情報源や手続きも含め人が判断（インプット情報なし） | 琥珀色（amber）＋左辺消失 |
| `sub_diagram_reference` | 部分審査機序図への参照 - 別図の処理全体を1つの処理として表現 | グレー＋+記号 |
| `consistency_check` | 整合確認処理 - 異なる情報源からの複数情報を比較・整合確認 | 緑色（green）＋☑記号 |

### process_type の選択基準（重要）

**`undefined_input` を使うケース**（設計図書等から人が読み取る入力情報）:
- 建築物の用途の特定
- 延べ面積・高さ等の数値の読み取り
- 構造種別の特定
- 屋根・外壁等の部位の特定
- 構造方法・仕様の確認
- 認定書の有無の確認

```json
// ✅ 正しい例: 設計図書から読み取る情報
{
  "id": "proc-use-check",
  "title": "用途の特定",
  "process_type": "undefined_input",
  "description": "設計図書等から建築物の用途を読み取る"
}
```

**`mechanical` を使うケース**（自動化可能な処理）:
- 都市計画データとの照合（区域指定の確認等）
- 幾何学的計算（延焼のおそれのある部分の判定等）
- 告示・基準との照合（大臣定め構造方法該当判定等）
- 論理演算（AND/OR判定、閾値比較等）
- 全称命題・存在命題の評価

```json
// ✅ 正しい例: 自動化可能な判定処理
{
  "id": "proc-exempt-check",
  "title": "適用除外判定",
  "process_type": "mechanical",
  "logic_expression": "(B1 ∈ {茶室等}) OR (B1 ∈ {物置等} AND B2 ≤ 10)"
}
```

**判断基準のポイント**:
- 「情報をどこから取得するか」が不定 → `undefined_input`
- 「入力が決まれば結果が一意に定まる」 → `mechanical`
- 公共データ（都市計画情報等）は `mechanical` の処理に内包

## 重要ルール

### 1. [情報]から[情報]への直接接続は禁止（必須）

**絶対禁止**: [情報]→[情報]の矢印

```
// ❌ ルール違反
[建築物種類] → [M1:茶室等該当]
[建築物種類] → [M2:物置等該当]

// ✅ 正しい: 区分情報で十分な場合は派生情報を作らない
[建築物種類] → [処理] → [適否判定]
```

**区分情報（classification）の解釈は[処理]に内包される**:
- 区分情報から「〜に該当するか」という命題への変換は、後続の[処理]が担当
- 区分情報があれば、それを解釈する派生[情報]は不要

### 2. [情報]として扱うべき情報

**[情報]として表現するもの:**
- 審査対象となる**個別の建築計画**についての情報

**[情報]として扱わないもの:**
- 法令そのものの知識 → [処理]に含まれる
- 都市計画情報などの公共データ → [処理]に含まれる

### 3. [情報]の単位と捉え方

[情報] = **主体** + **性質**

```json
// ✅ 正しい例
{
  "id": "info-001",
  "type": "information",
  "title": "建築物の高さ",
  "subject": "建築物",
  "property": "高さ",
  "property_type": "numeric",
  "unit": "m"
}
```

### 4. 複数主体と集合定義の扱い（重要）

**ページ内に主体の異なる情報が混在する場合**、それら相互の関係を明確にするために**集合定義型の[情報]を必ず追加する**。

#### set_definition が必須となるケース

**主体の親子関係がある場合は必ず set_definition を追加**:
- 「建築物」と「屋根」→「建築物に属する屋根」の集合定義が必要
- 「建築物」と「外壁」→「建築物に属する外壁」の集合定義が必要
- 「敷地」と「建築物」→「敷地に属する建築物」の集合定義が必要

```json
// ✅ 必須パターン: 建築物→屋根の関係がある場合
{
  "id": "info-roofs-set",
  "title": "建築物の屋根",
  "subject": "建築物",
  "property": "屋根の集合",
  "property_type": "set_definition",
  "description": "判定対象となる建築物に属する屋根を特定",
  "plurality": "single"  // 建築物1棟についての情報
}
{
  "id": "info-roof-material",
  "title": "屋根の構造",
  "subject": "屋根",
  "property": "構造種別",
  "property_type": "classification",
  "plurality": "multiple"  // 複数の屋根それぞれ
}
// edges: info-roofs-set → proc, info-roof-material → proc
```

```json
// ✅ 必須パターン: 敷地→建築物の関係がある場合
{
  "id": "info-buildings-set",
  "title": "敷地内の建築物",
  "subject": "敷地",
  "property": "建築物の集合",
  "property_type": "set_definition",
  "description": "当該敷地に属する建築物（既存を含む）を特定",
  "plurality": "single"  // 敷地1つについての情報
}
```

#### pluralityの設定基準（厳密版）

| 状況 | plurality | 例 |
|------|-----------|-----|
| 建築計画で1つに定まる情報 | `single` | 建築物の高さ、敷地面積 |
| 集合定義（親主体→子主体の関係定義） | `single` | 建築物に属する屋根の集合 |
| 複数要素それぞれの性質 | `multiple` | 各屋根の構造、各居室の床面積 |
| 「各〜」「すべての〜」の対象 | `multiple` | 各外壁の材料 |

**重要な判断基準**:
1. 「建築物」は通常 `single`（建築計画で1棟を対象）
2. 「敷地」は通常 `single`（建築計画で1つの敷地）
3. 「屋根」「外壁」「居室」など部品は条文の文脈で判断
   - 「屋根は〜」（一般的な言及）→ `multiple`
   - 「建築物の屋根」（特定建築物の）→ 集合定義で関係を明示

#### 主体関係チェックの手順

1. **主体の洗い出し**: 条文に登場する全ての主体をリスト化
2. **関係の特定**: 親子関係があるペアを特定
3. **set_definition追加**: 各親子ペアに対して集合定義型[情報]を追加
4. **plurality設定**: 上記基準に従って設定

### 5. [処理]に繋ぐべき[情報]

**必須の2種類:**
1. **対象特定情報**: どの主体に着眼するかを特定（集合定義型が多い）
2. **性質情報**: その主体のどの性質を使うか

```json
// ✅ 良い例: 処理対象と性質を別の[情報]として明示
{
  "id": "info-rooms",
  "title": "判定対象の居室",
  "subject": "建築物",
  "property": "居室の集合",
  "property_type": "set_definition",
  "plurality": "multiple"
}
{
  "id": "info-area",
  "title": "居室の床面積",
  "subject": "居室",
  "property": "床面積",
  "property_type": "numeric",
  "plurality": "multiple"
}
// edges: info-rooms → proc, info-area → proc
```

### 6. 入力情報の処理ノード分離（必須）

**禁止**: 複数の入力情報を1つの処理ノードでまとめて取得

```json
// ❌ 悪い例
{ "id": "proc-001", "title": "建築物諸元の特定" }
// edges: proc-001 → info-001, proc-001 → info-002, proc-001 → info-003
```

**正しい**: 入力情報ごとに個別の処理ノードを作成

```json
// ✅ 良い例
{ "id": "proc-001", "title": "高さの特定" }      // → info-001
{ "id": "proc-002", "title": "構造種別の特定" }  // → info-002
{ "id": "proc-003", "title": "階数の特定" }      // → info-003
```

**例外**: 計算処理（複数入力→1出力）は1つの処理ノードで可
- 例: `Ac = A - Asp × 0.5` → info-A, info-Asp → proc → info-Ac

### 7. 反復処理

複数の主体を対象として同様の処理を反復する場合:
- `iteration: "iterative"` を設定
- 入力の[情報]も出力の[情報]も`plurality: "multiple"`

### 8. 別表参照の展開

条文に「別表第一（い）欄（五）項」等がある場合、具体的内容を取得して反映。

```json
// ❌ 悪い例
{ "title": "別表第一(五)(六)該当", "description": "別表第一の用途" }

// ✅ 良い例
{
  "title": "倉庫・車庫等の用途",
  "description": "別表第一（い）欄（五）項（倉庫等）又は（六）項（自動車車庫等）",
  "remarks": "(五)倉庫その他これに類するもの、(六)自動車車庫、自動車修理工場"
}
```

## 法令ID一覧

| 法令 | ID |
|---|---|
| 建築基準法 | 325AC0000000201 |
| 建築基準法施行令 | 325CO0000000338 |
| 建築基準法施行規則 | 325M50004000040 |

## 関連条項記述規則

形式: `{法令略称}::A{条}:P{項}:I{号}`

- 建築基準法 = `法`
- 建築基準法施行令 = `令`
- 建築基準法施行規則 = `規則`

例: `法::A43:P1` → 法第43条第1項

## 図式構成ルール

1. **主体のノード化**: 対象主体（建築物等）は独立ノードにせず`subject`属性で参照
2. **接続規則**: 情報→処理→情報の流れ。**情報→情報の直接接続は禁止**
3. **レイアウト**: 左から右へ。最終情報（適否判定）は右端
4. **閾値分離**: 「1000㎡以下」は数値情報と判定処理に分離

## 生成チェックリスト

### 必須チェック（生成前）

- [ ] スキーマ（`schemas/kijo-diagram.schema.json`）を読み込んだか
- [ ] 規制文（〜ならない）を特定したか
- [ ] 別表参照がある場合、具体的内容を取得したか

### 主体・性質チェック

- [ ] [情報]は「主体+性質」で構成されているか
- [ ] property_typeは手引書の定義に基づいているか
- [ ] **主体の洗い出しを行ったか**（条文中の全主体をリスト化）
- [ ] **主体間の親子関係を特定したか**

### set_definition 必須チェック（最重要）

- [ ] **異なる主体が登場する場合、親子関係を確認したか**
- [ ] **親子関係がある場合、set_definition型の[情報]を追加したか**
  - 建築物⇔屋根 → 「建築物の屋根」（set_definition）
  - 建築物⇔外壁 → 「建築物の外壁」（set_definition）
  - 敷地⇔建築物 → 「敷地内の建築物」（set_definition）
- [ ] **set_definitionの追加理由を説明できるか**

### plurality チェック

- [ ] 建築計画で1つに定まる情報は `single` か
- [ ] 集合定義型は通常 `single`（親主体が1つなので）
- [ ] 「各〜」「すべての〜」の対象は `multiple` か
- [ ] 部品（屋根、外壁等）の性質は文脈に応じて設定したか

### 接続ルールチェック

- [ ] **[情報]→[情報]の直接接続がないか**（必ず[処理]を経由）
- [ ] **区分情報から派生する不要な命題[情報]を作っていないか**
- [ ] 入力情報ごとに個別の処理ノードを作成したか
- [ ] エッジのroleは正しく設定されているか（input/output）

### 処理ノードチェック

- [ ] process_typeは処理内容に適合しているか
- [ ] **設計図書から読み取る入力情報は `undefined_input` になっているか**
- [ ] **自動化可能な判定処理は `mechanical` になっているか**
- [ ] 視認情報は機械的処理（mechanical）に接続していないか
- [ ] 計算処理以外で複数出力を持つ処理がないか

### 最終確認

- [ ] **全エッジが [情報]→[処理] または [処理]→[情報] であるか**
- [ ] 別表参照を具体的に展開したか
- [ ] 孤立ノードがないか

## 参考

- 詳細手順: `prompts/機序図生成プロンプト.md`
- 手引書: `prompts/審査機序図作成手引書202403.md`
- ダイジェスト: `prompts/手引書ダイジェスト.md`
