# 審査機序図 詳細ルール

## 審査機序図とは

建築確認申請における計画案件の法適合判定における**情報処理のメカニズム**を表現するための図式。

### 目的
- 建築計画の法適合判定メカニズムと設計情報要件の明確化
- 審査ソフトウェアの機能要件定義

### 対象
- 個別の建築計画の設計内容を規制する条文（「規制文」）
- 「〜ならない。」で終わる文のうち、建築計画の立地条件や設計内容に関わるもの

## 構成要素

### ページタイトル
1枚の審査機序図が表す情報処理の概要を表現。

### [情報]ノード - 長方形
審査に必要なデータや判定結果を表す。**主体とその性質**で構成される。

- **主体**: 建築計画における物理的な物（壁、柱など）や幾何学的形状概念
- **性質**: 主体がもつ属性、他の主体との関係性

### [処理]ノード - 角丸長方形
情報を変換・判定する処理を表す。

### エッジ（矢印）
- **[情報]→[処理]**: 情報が処理に必要なインプット
- **[処理]→[情報]**: 情報が処理によって導出されたアウトプット

## [情報]の種類（property_type）

| 種類 | 説明 | 例 |
|------|------|-----|
| `proposition` | 命題真偽 | 技術基準を満たすか否か |
| `classification` | 区分情報 | 用途地域、建物用途コード |
| `numeric` | 数値 | 延べ面積、高さ |
| `geometric_point` | 幾何学概念（点） | 天空率の計測点 |
| `geometric_direction` | 幾何学概念（方向） | 真北 |
| `geometric_line` | 幾何学概念（線形状） | 避難動線 |
| `geometric_surface` | 幾何学概念（面形状） | 隣地境界 |
| `geometric_solid` | 幾何学概念（ソリッド） | 柱/壁の形状 |
| `set_definition` | 集合定義 | 階に属する外壁の集合 |
| `visual` | 視認情報 | 断面詳細図による告示仕様適合判断 |

## [処理]の種類（process_type）

| 種類 | 説明 | 表示 |
|------|------|------|
| `mechanical` | 自動化可能な論理演算や計算 | 水色 |
| `human_judgment` | 人の認識/判断を要する処理 | オレンジ色 |
| `undefined_input` | 情報源や手続きも含め人が判断 | 琥珀色＋左辺消失 |
| `sub_diagram_reference` | 別図の処理全体を1つの処理として表現 | グレー＋+記号 |
| `consistency_check` | 異なる情報源からの複数情報を比較・整合確認 | 緑色＋☑記号 |

### process_type の選択基準

**`undefined_input` を使うケース**:
- 建築物の用途の特定
- 延べ面積・高さ等の数値の読み取り
- 構造種別の特定
- 屋根・外壁等の部位の特定
- 構造方法・仕様の確認
- 認定書の有無の確認

```json
{
  "id": "proc-use-check",
  "title": "用途の特定",
  "process_type": "undefined_input",
  "description": "設計図書等から建築物の用途を読み取る"
}
```

**`mechanical` を使うケース**:
- 都市計画データとの照合
- 幾何学的計算
- 告示・基準との照合
- 論理演算（AND/OR判定、閾値比較等）
- 全称命題・存在命題の評価

```json
{
  "id": "proc-exempt-check",
  "title": "適用除外判定",
  "process_type": "mechanical",
  "logic_expression": "(B1 ∈ {茶室等}) OR (B1 ∈ {物置等} AND B2 ≤ 10)"
}
```

**判断基準のポイント**:
- 「情報をどこから取得するか」が不定 → `undefined_input`
- 「入力が決まれば結果が一意に定まる」 → `mechanical`
- 公共データ（都市計画情報等）は `mechanical` の処理に内包

## 重要ルール

### 1. [情報]から[情報]への直接接続は禁止

**絶対禁止**: [情報]→[情報]の矢印

```
// ❌ ルール違反
[建築物種類] → [M1:茶室等該当]

// ✅ 正しい
[建築物種類] → [処理] → [適否判定]
```

**区分情報（classification）の解釈は[処理]に内包される**

### 2. [情報]として扱うべき情報

**[情報]として表現するもの:**
- 審査対象となる**個別の建築計画**についての情報

**[情報]として扱わないもの:**
- 法令そのものの知識 → [処理]に含まれる
- 都市計画情報などの公共データ → [処理]に含まれる

### 3. [情報]の単位と捉え方

[情報] = **主体** + **性質**

```json
{
  "id": "info-001",
  "type": "information",
  "title": "建築物の高さ",
  "subject": "建築物",
  "property": "高さ",
  "property_type": "numeric",
  "unit": "m"
}
```

### 4. 複数主体と集合定義の扱い

**主体の親子関係がある場合は必ず set_definition を追加**:
- 「建築物」と「屋根」→「建築物に属する屋根」の集合定義が必要
- 「建築物」と「外壁」→「建築物に属する外壁」の集合定義が必要
- 「敷地」と「建築物」→「敷地に属する建築物」の集合定義が必要

```json
{
  "id": "info-roofs-set",
  "title": "建築物の屋根",
  "subject": "建築物",
  "property": "屋根の集合",
  "property_type": "set_definition",
  "description": "判定対象となる建築物に属する屋根を特定",
  "plurality": "single"
}
```

#### pluralityの設定基準

| 状況 | plurality | 例 |
|------|-----------|-----|
| 建築計画で1つに定まる情報 | `single` | 建築物の高さ、敷地面積 |
| 集合定義（親主体→子主体の関係定義） | `single` | 建築物に属する屋根の集合 |
| 複数要素それぞれの性質 | `multiple` | 各屋根の構造、各居室の床面積 |
| 「各〜」「すべての〜」の対象 | `multiple` | 各外壁の材料 |

### 5. [処理]に繋ぐべき[情報]

**必須の2種類:**
1. **対象特定情報**: どの主体に着眼するかを特定（集合定義型が多い）
2. **性質情報**: その主体のどの性質を使うか

### 6. 入力情報の処理ノード分離

**禁止**: 複数の入力情報を1つの処理ノードでまとめて取得

```json
// ❌ 悪い例
{ "id": "proc-001", "title": "建築物諸元の特定" }

// ✅ 良い例
{ "id": "proc-001", "title": "高さの特定" }
{ "id": "proc-002", "title": "構造種別の特定" }
{ "id": "proc-003", "title": "階数の特定" }
```

**例外**: 計算処理（複数入力→1出力）は1つの処理ノードで可

### 7. 反復処理

複数の主体を対象として同様の処理を反復する場合:
- `iteration: "iterative"` を設定
- 入力の[情報]も出力の[情報]も`plurality: "multiple"`

### 8. 別表参照の展開

条文に「別表第一（い）欄（五）項」等がある場合、具体的内容を取得して反映。

```json
// ❌ 悪い例
{ "title": "別表第一(五)(六)該当" }

// ✅ 良い例
{
  "title": "倉庫・車庫等の用途",
  "description": "別表第一（い）欄（五）項（倉庫等）又は（六）項（自動車車庫等）",
  "remarks": "(五)倉庫その他これに類するもの、(六)自動車車庫、自動車修理工場"
}
```

## 公共データの扱い

**公共データ（都市計画情報等）は kijo_diagram のノードに含めてはならない。**

審査機序図における[情報]は、**審査対象となる個別の建築計画についての情報に限定**される。
都市計画情報のような公共データは[処理]の中に含まれると考え、図上には表現しない。

```json
// ❌ 誤り
{
  "kijo_diagram": {
    "nodes": [
      { "id": "info-zone", "title": "敷地の区域区分", "type": "information" }
    ]
  }
}

// ✅ 正しい
{
  "compliance_logic": {
    "scope_condition": {
      "operator": "AND",
      "conditions": [
        { "type": "location", "value": "法22条区域内" }
      ]
    }
  }
}
```

## 関連条項記述規則

形式: `{法令略称}::A{条}:P{項}:I{号}`

- 建築基準法 = `法`
- 建築基準法施行令 = `令`
- 建築基準法施行規則 = `規則`

例: `法::A43:P1` → 法第43条第1項

## 図式構成ルール

1. **主体のノード化**: 対象主体は独立ノードにせず`subject`属性で参照
2. **接続規則**: 情報→処理→情報の流れ。**情報→情報の直接接続は禁止**
3. **レイアウト**: 左から右へ。最終情報（適否判定）は右端
4. **閾値分離**: 「1000㎡以下」は数値情報と判定処理に分離
