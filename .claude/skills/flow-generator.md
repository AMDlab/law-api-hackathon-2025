# 適合判定フロー図生成スキル

機序図JSONから適合判定フロー図を生成する。

## トリガー

- 「フロー図を作成」「フロー図を生成」
- 「適合判定フロー」
- 機序図を元にしたフロー図作成リクエスト

## スキーマ

**必ず `schemas/flow-diagram.schema.json` を読み込んでから作業すること。**

## 前提条件

機序図JSON（`*_kijo.json`）が必要。存在しない場合は先に機序図を作成。

## 作業フロー

### STEP 1: スキーマ読み込み
```
schemas/flow-diagram.schema.json を読む
```

### STEP 2: 機序図読み込み

対象ファイル: `data/diagrams/{法令ID}/A{条}_P{項}_kijo.json`

抽出する情報:
1. **kijo_diagram.nodes**: 情報ノード・処理ノード
2. **compliance_logic**: 適用範囲・判定ルール・例外条件
3. **処理ノードの`logic_expression`**: フロー分岐の基礎

### STEP 3: 処理ノード論理式分析

`logic_expression`からフロー図の判定条件を導出:

| logic_expression | フロー図のdecision |
|---|---|
| `A > 1500` | 「延べ面積 > 1500㎡？」 |
| `T ∈ {準耐火, 耐火}` | 「準耐火建築物等か？」 |
| `E1 OR E2 OR E3` | 各号を個別decisionに展開 |

### STEP 4: 「各号」展開

`exceptions.conditions`に「各号のいずれか」がある場合:
1. 各号を個別のdecisionノードに展開
2. **途中経過ノード（process）を追加**（例: 「1号該当」）
3. 付随条件は各号判定の**後**に配置

### STEP 5: JSON出力

**分離ファイルとして出力:**
- 出力先: `data/diagrams/{法令ID}/A{条}_P{項}_flow.json`
- 例: `A22_P1_kijo.json` → `A22_P1_flow.json`

**ファイル命名規則:**
- フロー図: `A{条}_P{項}_flow.json`（例: `A22_P1_flow.json`）
- 枝番あり: `A{条}_{枝番}_P{項}_flow.json`（例: `A20_3_P2_flow.json`）

**参照設定:**
- `kijo_diagram_ref`: 対応する機序図のIDを設定（例: `A22_P1_kijo`）

## 重要ルール

### 1. 「〜を特定したか？」分岐の禁止（最重要）

**禁止**: 情報の特定自体を問う分岐

```
// ❌ 禁止パターン
[構造種別を特定したか？] ─yes/no→
[用途を確認したか？] ─yes/no→
[敷地の状況を特定したか？] ─yes/no→

// ✅ 正しいパターン: 特定した結果の値で分岐
[構造種別は？] ─木造/耐火/準耐火/その他→
[用途は？] ─住居系/商業系/工業系→
[敷地は防火・準防火地域か？] ─yes/no→
```

### 2. 分岐タイプの選択

#### binary分岐（yes/no）
真偽を問う質問に使用。

```json
{
  "id": "dec-fireproof",
  "type": "decision",
  "title": "耐火建築物等か？",
  "decision_type": "binary"
}
// エッジ: role="yes" / role="no"
```

#### multi分岐（値による多方向）
区分情報の値で分岐する場合に使用。

```json
{
  "id": "dec-structure",
  "type": "decision",
  "title": "構造種別は？",
  "decision_type": "multi",
  "options": [
    { "value": "木造" },
    { "value": "耐火構造" },
    { "value": "準耐火構造" },
    { "value": "その他" }
  ]
}
// エッジ: role="option", label="木造" など
```

### 3. 分岐タイプ選択の基準

| 機序図の情報 | フロー図の分岐タイプ | 例 |
|-------------|---------------------|-----|
| property_type=proposition | binary | 「〜に該当するか？」 |
| property_type=classification | **multi** | 「構造種別は？」 |
| property_type=numeric (比較) | binary | 「面積>1000㎡か？」 |
| property_type=numeric (範囲) | multi | 「階数は？(1/2/3以上)」 |

### 4. ノード数の検証（必須）

**フロー図は機序図より詳しくなければならない**

| 検証項目 | 基準 |
|---------|------|
| 機序図の`process`ノード数 | N個 |
| フロー図の`decision`ノード数 | **N個以上** |

### 5. ノードタイトルのわかりやすさ（必須）

**禁止**: 他条文の番号をタイトルに含める

```
// ❌ 悪い例
"title": "法6条1項2号でH>13mまたは軒高>9m？"

// ✅ 良い例
"title": "大規模木造（H>13mまたは軒高>9m）？"
```

条文参照は`description`に記載。タイトルは実質的な意味で表現する。

### 6. 途中経過ノード（必須）

各号に該当した場合は必ずprocessノードを挟む:

```
// ❌ 誤り
[劇場等か？] ─はい→ [用途上やむを得ない？]

// ✅ 正しい
[劇場等か？] ─はい→ [1号該当] → [用途上やむを得ない？]
```

### 7. 別表参照の展開

別表を参照する条文は、各項を個別decisionに展開:

```json
{ "id": "dec-use-5", "title": "倉庫等の用途？", "description": "別表第一(五)項" }
{ "id": "dec-use-6", "title": "自動車車庫等の用途？", "description": "別表第一(六)項" }
```

## フロー構造パターン

### 多方向分岐（multi）
```
[構造種別は？]
    ├─ 木造 → [木造の場合の処理へ]
    ├─ 耐火構造 → [適合]
    ├─ 準耐火構造 → [準耐火の追加確認へ]
    └─ その他 → [その他構造の確認へ]
```

### 真偽分岐（binary）
```
[耐火建築物等か？]
    ├─ yes → [適合]
    └─ no → [次の条件へ]
```

### OR条件（各号のいずれか）
```
[号1に該当？]
    ├─ yes → [号1該当] → [付随条件？] ─yes→ 適合（例外）
    │                                  └─no→ 本則確認へ
    └─ no → [号2に該当？] → ...
```

### AND条件（すべて満たす）
```
[条件1] ─yes→ [条件2] ─yes→ 適合
    │              └─no→ 不適合
    └─no→ 不適合
```

## 生成チェックリスト

### 必須チェック（生成前）
- [ ] スキーマ（`schemas/flow-diagram.schema.json`）を読み込んだか
- [ ] 機序図の`logic_expression`を全て分析したか

### 分岐ノードチェック（最重要）
- [ ] **「〜を特定したか？」という分岐がないか**
- [ ] **「〜の確認」という分岐がないか**
- [ ] 区分情報（classification）には`decision_type=multi`を使用したか
- [ ] multi分岐には`options`と`role=option`のエッジを設定したか
- [ ] ノードタイトルは条文番号でなく実質的意味か

### 構造チェック
- [ ] フロー図のdecision数 >= 機序図のprocess数か
- [ ] 各号を個別decisionに展開したか
- [ ] 号該当時の途中経過ノード（process）を追加したか
- [ ] 付随条件を各号判定の後に配置したか

### エッジチェック
- [ ] binary分岐には`role=yes/no`を設定したか
- [ ] multi分岐には`role=option`と`label`を設定したか
- [ ] 通常の接続には`role=flow`を設定したか
- [ ] 全パスがterminalに到達するか

## 参考

- 詳細手順: `prompts/適合判定フロー図生成プロンプト.md`
