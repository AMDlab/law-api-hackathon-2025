datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum DiagramType {
  kijo
  flow
}

enum LawType {
  act
  order
  regulation
  notice
}

enum DiagramNodeType {
  information
  process
  decision
  terminal
}

enum EdgeRole {
  input
  output
  primary
  supporting
  yes
  no
  option
  flow
}

enum UserRole {
  designer
  bim_specialist
  ifc_specialist
  bim_software_programmer
  reviewer
  review_software_programmer
}

enum CommentTargetType {
  node
  edge
}

enum RelatedLawRelationship {
  delegates_to
  delegated_from
  defines_detail
  references
  supersedes
}

model Diagram {
  diagramKey            String                @id
  baseId                String
  diagramType           DiagramType
  lawId                 String
  schemaId              String?
  version               String
  pageTitleTitle        String
  pageTitleTargetSubject String?
  pageTitleDescription  String?
  lawType               LawType
  lawName               String
  lawAbbrev             String
  article               String
  paragraph             String?
  item                  String?
  textRaw               String?
  complianceLogic       Json?
  diagramTitle          String?
  diagramDescription    String?
  kijoDiagramRef        String?
  metadata              Json?

  labels                DiagramLabel[]
  relatedLaws            RelatedLaw[]
  nodes                 DiagramNode[]
  edges                 DiagramEdge[]
  snapshots             DiagramSnapshot[]
  commentThreads        DiagramCommentThread[]

  @@index([lawId])
  @@index([baseId])
  @@index([diagramType])
}

model DiagramLabel {
  id         String  @id @default(cuid())
  diagramKey String
  label      String

  diagram    Diagram @relation(fields: [diagramKey], references: [diagramKey], onDelete: Cascade)

  @@index([diagramKey])
}

model RelatedLaw {
  id           String                 @id @default(cuid())
  diagramKey   String
  lawId        String
  lawName      String
  lawType      LawType
  relationship RelatedLawRelationship
  articles     String[]               @default([])
  description  String?

  diagram      Diagram @relation(fields: [diagramKey], references: [diagramKey], onDelete: Cascade)

  @@index([diagramKey])
}

model DiagramNode {
  id         String          @id @default(cuid())
  diagramKey String
  nodeId     String
  type       DiagramNodeType
  title      String
  data       Json?

  diagram    Diagram         @relation(fields: [diagramKey], references: [diagramKey], onDelete: Cascade)

  @@unique([diagramKey, nodeId])
  @@index([diagramKey])
}

model DiagramEdge {
  id         String   @id @default(cuid())
  diagramKey String
  edgeId     String
  fromId     String
  toId       String
  role       EdgeRole?
  label      String?

  diagram    Diagram  @relation(fields: [diagramKey], references: [diagramKey], onDelete: Cascade)

  @@unique([diagramKey, edgeId])
  @@index([diagramKey])
}

model DiagramSnapshot {
  id         String      @id @default(cuid())
  diagramKey String
  diagramType DiagramType
  snapshot   Json
  note       String?
  createdAt  DateTime    @default(now())

  diagram    Diagram     @relation(fields: [diagramKey], references: [diagramKey], onDelete: Cascade)

  @@index([diagramKey])
  @@index([diagramType])
  @@index([createdAt])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  familyName    String
  givenName     String
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          UserRole
  passwordHash  String?
  accounts      Account[]
  sessions      Session[]
  comments      DiagramComment[]
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model DiagramCommentThread {
  id         String           @id @default(cuid())
  diagramKey String
  diagramType DiagramType
  targetType CommentTargetType
  targetId   String
  offsetX    Float
  offsetY    Float
  isResolved Boolean          @default(false)
  resolvedAt DateTime?
  isDeleted  Boolean          @default(false)
  deletedAt  DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  diagram    Diagram          @relation(fields: [diagramKey], references: [diagramKey], onDelete: Cascade)
  comments   DiagramComment[]

  @@index([diagramKey, diagramType])
  @@index([targetType, targetId])
}

model DiagramComment {
  id         String             @id @default(cuid())
  threadId   String
  userId     String
  authorName String
  authorRole UserRole
  body       String
  isDeleted  Boolean            @default(false)
  deletedAt  DateTime?
  createdAt  DateTime           @default(now())

  thread     DiagramCommentThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([userId])
}
