{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/kijo-diagram.schema.json",
  "title": "審査機序図スキーマ v3.1",
  "description": "buildingSMART Japan 審査機序図作成手引書に基づく機序図データ形式。審査機序図は、建築確認申請における計画案件の法適合判定における情報処理のメカニズムを表現するための図式である。",
  "type": "object",
  "required": ["id", "version", "page_title", "legal_ref", "kijo_diagram"],
  "properties": {
    "id": {
      "type": "string",
      "description": "機序図の一意識別子（例: CHK-BSL-A22-P1）"
    },
    "version": {
      "type": "string",
      "description": "スキーマバージョン",
      "default": "3.0.0"
    },
    "page_title": {
      "$ref": "#/definitions/PageTitle"
    },
    "legal_ref": {
      "$ref": "#/definitions/LegalRef"
    },
    "labels": {
      "type": "array",
      "description": "ラベル（単体規定/集団規定、カテゴリ等）",
      "items": {
        "type": "string"
      }
    },
    "text_raw": {
      "type": "string",
      "description": "条文の原文テキスト"
    },
    "compliance_logic": {
      "$ref": "#/definitions/ComplianceLogic"
    },
    "kijo_diagram": {
      "$ref": "#/definitions/Diagram",
      "description": "機序図のノードとエッジ構造"
    },
    "flow_diagram": {
      "$ref": "#/definitions/FlowDiagram",
      "description": "適合判定フロー図（オプション）"
    },
    "related_laws": {
      "type": "array",
      "description": "関連法令（法→令→規則の参照関係）",
      "items": {
        "$ref": "#/definitions/RelatedLaw"
      }
    },
    "metadata": {
      "$ref": "#/definitions/Metadata"
    }
  },
  "definitions": {
    "PageTitle": {
      "type": "object",
      "description": "ページタイトル図形の情報",
      "required": ["title"],
      "properties": {
        "title": {
          "type": "string",
          "description": "図形上に表示するタイトル"
        },
        "target_subject": {
          "type": "string",
          "description": "ページ全体が対象とする主体"
        },
        "description": {
          "type": "string",
          "description": "ページ全体の処理内容"
        }
      }
    },
    "LegalRef": {
      "type": "object",
      "description": "法令参照情報",
      "required": ["law_id", "law_type", "law_name", "law_abbrev", "article"],
      "properties": {
        "law_id": {
          "type": "string",
          "description": "法令ID（e-Gov法令API準拠）"
        },
        "law_type": {
          "type": "string",
          "description": "法令種別",
          "enum": ["act", "order", "regulation", "notice"]
        },
        "law_name": {
          "type": "string",
          "description": "法令名"
        },
        "law_abbrev": {
          "type": "string",
          "description": "法令略称（法、令、規則等）"
        },
        "article": {
          "type": "string",
          "description": "条番号"
        },
        "paragraph": {
          "type": ["string", "null"],
          "description": "項番号"
        },
        "item": {
          "type": ["string", "null"],
          "description": "号番号"
        }
      }
    },
    "ComplianceLogic": {
      "type": "object",
      "description": "適合判定ロジック",
      "properties": {
        "scope_condition": {
          "type": "object",
          "description": "適用範囲条件",
          "properties": {
            "operator": {
              "type": "string",
              "description": "論理演算子"
            },
            "value": {
              "type": "boolean"
            },
            "conditions": {
              "type": "array",
              "items": {
                "type": "object"
              }
            },
            "note": {
              "type": "string"
            }
          }
        },
        "judgment_rule": {
          "type": "object",
          "description": "判定ルール",
          "properties": {
            "operator": {
              "type": "string"
            },
            "lhs": {
              "type": "object"
            },
            "rhs": {
              "type": "object"
            },
            "conditions": {
              "type": "array",
              "items": {
                "type": "object"
              }
            }
          }
        },
        "exceptions": {
          "type": ["object", "null"],
          "description": "例外条件（ただし書き等）",
          "properties": {
            "operator": {
              "type": "string"
            },
            "conditions": {
              "type": "array",
              "items": {
                "type": "object"
              }
            },
            "effect": {
              "type": "string",
              "description": "例外の効果（EXEMPT等）"
            }
          }
        }
      }
    },
    "Diagram": {
      "type": "object",
      "description": "機序図のノードとエッジ",
      "required": ["nodes", "edges"],
      "properties": {
        "nodes": {
          "type": "array",
          "description": "[情報]と[処理]のノード一覧",
          "items": {
            "oneOf": [
              { "$ref": "#/definitions/InformationNode" },
              { "$ref": "#/definitions/ProcessNode" }
            ]
          },
          "minItems": 1
        },
        "edges": {
          "type": "array",
          "description": "ノード間の接続（矢印）",
          "items": {
            "$ref": "#/definitions/Edge"
          }
        }
      }
    },
    "InformationNode": {
      "type": "object",
      "description": "[情報]ノード - 法適合判定に関与する情報を表す矩形。[情報]は主体とその性質で構成される。主体は建築計画における物理的な物（壁、柱など）や幾何学的形状概念（床面積算定領域、敷地境界線など）。性質は主体がもつ属性や他の主体との関係性。【重要】異なる主体が混在する場合（例: 建築物と屋根）、親主体から子主体への関係を示す set_definition 型の[情報]が必須。",
      "required": ["id", "type", "title"],
      "properties": {
        "id": {
          "type": "string",
          "description": "ノードの一意識別子"
        },
        "type": {
          "type": "string",
          "const": "information"
        },
        "title": {
          "type": "string",
          "description": "図形上に表示するタイトル"
        },
        "symbol": {
          "type": "string",
          "description": "論理式等で用いる記号（例: A, B, X1）",
          "pattern": "^[A-Za-z][A-Za-z0-9_]*$"
        },
        "subject": {
          "type": "string",
          "description": "情報を保持する主体（例: 建築物, 室, 敷地, 壁, 柱）。建築計画において数えることができるもの。"
        },
        "plurality": {
          "type": "string",
          "description": "単数か複数か。複数の場合は二重線で表示。【設定基準】single: 建築計画で1つに定まる情報（建築物の高さ等）、集合定義型（親主体が1つ）。multiple: 複数要素それぞれの性質（各屋根の構造等）、「各〜」「すべての〜」の対象。",
          "enum": ["single", "multiple"],
          "default": "single"
        },
        "property": {
          "type": "string",
          "description": "主体がもつ性質（属性、他の主体との関係性、特定情報）"
        },
        "property_type": {
          "type": "string",
          "description": "性質の型。手引書に基づく分類。",
          "enum": [
            "proposition",
            "classification",
            "numeric",
            "geometric_point",
            "geometric_direction",
            "geometric_line",
            "geometric_surface",
            "geometric_solid",
            "set_definition",
            "visual"
          ]
        },
        "property_type_description": {
          "type": "string",
          "description": "property_typeの説明",
          "enum": [
            "命題真偽 - 真か偽かが判定可能な事実（例: 技術基準を満たすか否か）",
            "区分情報 - 既定のいくつかの区分の中のいずれかを示すもの（例: 用途地域、建物用途コード）",
            "数値 - 大小関係に位置づけられる整数値または実数値（例: 延べ面積、高さ）",
            "幾何学概念（点） - 例: 天空率の計測点、開口部の中心点",
            "幾何学概念（方向） - 例: 真北",
            "幾何学概念（線形状） - 例: 避難動線、建物と地盤面の接する線",
            "幾何学概念（面形状） - 例: 隣地境界",
            "幾何学概念（ソリッド） - 例: 柱/壁の形状、延焼のおそれのある部分",
            "集合定義 - 主体と特定の関係にある他の主体がどれであるかを示す情報（例: 階に属する外壁の集合）【必須ケース: 建築物⇔屋根、建築物⇔外壁、敷地⇔建築物など親子関係がある場合】",
            "視認情報 - 人による総合的な認識や判断を必要とする状況や状態。機械可読性のない情報全般（例: 告示仕様適合判断のための断面詳細図）"
          ]
        },
        "unit": {
          "type": "string",
          "description": "数値の単位（property_type=numericの場合）"
        },
        "description": {
          "type": "string",
          "description": "情報内容の説明"
        },
        "related_articles": {
          "type": "array",
          "description": "関連法令条項（例: 令::A109_9）",
          "items": {
            "type": "string"
          }
        },
        "delegated_requirements": {
          "type": "array",
          "description": "委任先法令の要件詳細（号単位）",
          "items": {
            "$ref": "#/definitions/DelegatedRequirement"
          }
        },
        "remarks": {
          "type": "string",
          "description": "備考"
        },
        "mvd_related": {
          "type": "string",
          "description": "IFC適用クラスやPropertySet情報"
        }
      }
    },
    "DelegatedRequirement": {
      "type": "object",
      "description": "委任先法令の要件詳細",
      "required": ["article_ref", "requirement"],
      "properties": {
        "article_ref": {
          "type": "string",
          "description": "条項参照（例: 令::A109_9:P1:I1）"
        },
        "requirement": {
          "type": "string",
          "description": "要件の内容"
        }
      }
    },
    "ProcessNode": {
      "type": "object",
      "description": "[処理]ノード - 情報を処理して別の情報を導出する角丸矩形。[処理]に繋ぐべき[情報]は、処理対象としてどの主体に着眼するかを特定する情報と、各主体のどのような性質について知りたいのかを表す[情報]に大別される。",
      "required": ["id", "type", "title", "process_type"],
      "properties": {
        "id": {
          "type": "string",
          "description": "ノードの一意識別子"
        },
        "type": {
          "type": "string",
          "const": "process"
        },
        "title": {
          "type": "string",
          "description": "図形上に表示するタイトル"
        },
        "process_type": {
          "type": "string",
          "description": "処理の種類。手引書に基づく分類。",
          "enum": [
            "mechanical",
            "human_judgment",
            "consistency_check",
            "sub_diagram_reference",
            "undefined_input"
          ]
        },
        "process_type_description": {
          "type": "string",
          "description": "process_typeの説明",
          "enum": [
            "機械的処理 - 自動化可能な論理演算や計算。視認情報をこれに繋ぐことはできない。水色で表示。",
            "人の認識/判断を要する処理 - 人の認識/判断を要する処理。肌色で表示。",
            "整合確認処理 - 異なる情報源から導かれた複数の情報を比較し整合確認を行う。☑記号を付加。",
            "部分審査機序図への参照 - 別途作成された部分審査機序図の情報処理全体をひとつの[処理]として表現。+記号を付加。",
            "入力情報不定処理 - 導出されるアウトプット情報を得るための情報源の所在や手続きのメカニズムも含めて人が判断する処理。インプット情報を繋がない。左側の辺を消した状態で表示。"
          ]
        },
        "target_subject": {
          "type": "string",
          "description": "処理対象となる主体の型"
        },
        "iteration": {
          "type": "string",
          "description": "単体処理か反復処理か",
          "enum": ["single", "iterative"],
          "default": "single"
        },
        "description": {
          "type": "string",
          "description": "処理の概要説明"
        },
        "related_articles": {
          "type": "array",
          "description": "関連法令条項",
          "items": {
            "type": "string"
          }
        },
        "remarks": {
          "type": "string",
          "description": "備考"
        },
        "logic_expression": {
          "type": "string",
          "description": "論理式等（入力情報の記号を用いた処理内容の表現）"
        },
        "software_functions": {
          "type": "array",
          "description": "ソフトウェア機能（最大3つ）",
          "maxItems": 3,
          "items": {
            "$ref": "#/definitions/SoftwareFunction"
          }
        },
        "sub_diagram_ref": {
          "type": "string",
          "description": "参照する部分審査機序図のID（process_type=sub_diagram_referenceの場合）"
        }
      }
    },
    "SoftwareFunction": {
      "type": "object",
      "description": "ソフトウェア機能定義",
      "properties": {
        "category": {
          "type": "string",
          "description": "機能区分",
          "enum": [
            "user_input",
            "graphic_display",
            "text_display",
            "program_processing"
          ]
        },
        "description": {
          "type": "string",
          "description": "機能概要"
        }
      }
    },
    "Edge": {
      "type": "object",
      "description": "ノード間の接続（矢印）。【重要ルール】[情報]→[情報]の直接接続は禁止。必ず[情報]→[処理]または[処理]→[情報]の形式。",
      "required": ["id", "from", "to"],
      "properties": {
        "id": {
          "type": "string",
          "description": "エッジの一意識別子"
        },
        "from": {
          "type": "string",
          "description": "始点ノードのID"
        },
        "to": {
          "type": "string",
          "description": "終点ノードのID"
        },
        "role": {
          "type": "string",
          "description": "エッジの役割",
          "enum": ["input", "output", "primary", "supporting"],
          "default": "input"
        }
      }
    },
    "RelatedLaw": {
      "type": "object",
      "description": "関連法令情報",
      "required": ["law_id", "law_name", "law_type", "relationship"],
      "properties": {
        "law_id": {
          "type": "string",
          "description": "関連法令ID（e-Gov法令API準拠）"
        },
        "law_name": {
          "type": "string",
          "description": "関連法令名"
        },
        "law_type": {
          "type": "string",
          "description": "法令種別",
          "enum": ["act", "order", "regulation", "notice"]
        },
        "relationship": {
          "type": "string",
          "description": "関係性の種類",
          "enum": [
            "delegates_to",
            "delegated_from",
            "defines_detail",
            "references",
            "supersedes"
          ]
        },
        "articles": {
          "type": "array",
          "description": "関連する条項（例: A112:P1）",
          "items": {
            "type": "string"
          }
        },
        "description": {
          "type": "string",
          "description": "関係性の説明"
        }
      }
    },
    "FlowDiagram": {
      "type": "object",
      "description": "適合判定フロー図",
      "properties": {
        "title": {
          "type": "string",
          "description": "フロー図のタイトル"
        },
        "description": {
          "type": "string",
          "description": "フロー図の説明"
        },
        "nodes": {
          "type": "array",
          "description": "フロー図のノード一覧",
          "items": {
            "oneOf": [
              { "$ref": "#/definitions/TerminalNode" },
              { "$ref": "#/definitions/DecisionNode" },
              { "$ref": "#/definitions/ProcessNode" }
            ]
          }
        },
        "edges": {
          "type": "array",
          "description": "ノード間の接続",
          "items": {
            "$ref": "#/definitions/FlowEdge"
          }
        }
      },
      "required": ["nodes", "edges"]
    },
    "TerminalNode": {
      "type": "object",
      "description": "開始・終了ノード（楕円形）",
      "required": ["id", "type", "title", "result"],
      "properties": {
        "id": {
          "type": "string",
          "description": "ノードの一意識別子"
        },
        "type": {
          "type": "string",
          "const": "terminal"
        },
        "title": {
          "type": "string",
          "description": "表示タイトル"
        },
        "result": {
          "type": "string",
          "description": "結果の種類",
          "enum": ["start", "end", "pass", "fail"]
        },
        "description": {
          "type": "string",
          "description": "結果の説明"
        },
        "related_articles": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "DecisionNode": {
      "type": "object",
      "description": "条件分岐ノード",
      "required": ["id", "type", "title"],
      "properties": {
        "id": {
          "type": "string",
          "description": "ノードの一意識別子"
        },
        "type": {
          "type": "string",
          "const": "decision"
        },
        "title": {
          "type": "string",
          "description": "判定条件の質問形式"
        },
        "description": {
          "type": "string",
          "description": "判定条件の詳細説明"
        },
        "condition": {
          "type": "object",
          "properties": {
            "operator": { "type": "string" },
            "lhs": { "type": "object" },
            "rhs": { "type": "object" }
          }
        },
        "related_articles": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "FlowEdge": {
      "type": "object",
      "description": "フロー図のエッジ",
      "required": ["id", "from", "to", "role"],
      "properties": {
        "id": {
          "type": "string",
          "description": "エッジの一意識別子"
        },
        "from": {
          "type": "string",
          "description": "始点ノードのID"
        },
        "to": {
          "type": "string",
          "description": "終点ノードのID"
        },
        "role": {
          "type": "string",
          "description": "エッジの役割",
          "enum": ["yes", "no", "flow"]
        },
        "label": {
          "type": "string",
          "description": "表示ラベル"
        }
      }
    },
    "Metadata": {
      "type": "object",
      "description": "メタデータ",
      "properties": {
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "作成日時"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "更新日時"
        },
        "author": {
          "type": "string",
          "description": "作成者"
        },
        "generator": {
          "type": "string",
          "description": "生成ツール（例: kijo-orchestrator-v1）"
        },
        "law_id": {
          "type": "string",
          "description": "対象法令ID（e-Gov法令API準拠）"
        },
        "law_name": {
          "type": "string",
          "description": "対象法令名"
        },
        "checklist_ref": {
          "type": "string",
          "description": "チェックリスト参照"
        },
        "source": {
          "type": "string",
          "description": "データソース情報"
        }
      }
    }
  }
}
