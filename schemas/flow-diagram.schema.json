{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/flow-diagram.schema.json",
  "title": "適合判定フロー図スキーマ（分離形式）",
  "description": "機序図とは別ファイルで保存される適合判定フローチャートのデータ形式",
  "type": "object",
  "required": ["id", "version", "page_title", "legal_ref", "flow_diagram"],
  "properties": {
    "id": {
      "type": "string",
      "description": "フロー図の一意識別子（例: A22_P1_flow）"
    },
    "version": {
      "type": "string",
      "description": "スキーマバージョン（例: 3.2）"
    },
    "page_title": {
      "$ref": "#/definitions/PageTitle"
    },
    "legal_ref": {
      "$ref": "#/definitions/LegalRef"
    },
    "labels": {
      "type": "array",
      "description": "ラベル（検索・分類用）",
      "items": { "type": "string" }
    },
    "text_raw": {
      "type": "string",
      "description": "元の条文テキスト"
    },
    "compliance_logic": {
      "$ref": "#/definitions/ComplianceLogic"
    },
    "flow_diagram": {
      "$ref": "#/definitions/FlowDiagramInfo"
    },
    "kijo_diagram_ref": {
      "type": "string",
      "description": "対応する機序図のID（例: A22_P1_kijo）"
    },
    "related_laws": {
      "type": "array",
      "description": "関連法令",
      "items": { "$ref": "#/definitions/RelatedLaw" }
    },
    "metadata": {
      "$ref": "#/definitions/DiagramMetadata"
    }
  },
  "definitions": {
    "PageTitle": {
      "type": "object",
      "required": ["title"],
      "properties": {
        "title": {
          "type": "string",
          "description": "ページタイトル"
        },
        "target_subject": {
          "type": "string",
          "description": "対象主体"
        },
        "description": {
          "type": "string",
          "description": "説明"
        }
      }
    },
    "LegalRef": {
      "type": "object",
      "required": ["law_id", "law_type", "law_name", "law_abbrev", "article"],
      "properties": {
        "law_id": { "type": "string" },
        "law_type": {
          "type": "string",
          "enum": ["act", "order", "regulation", "notice"]
        },
        "law_name": { "type": "string" },
        "law_abbrev": { "type": "string" },
        "article": { "type": "string" },
        "paragraph": { "type": ["string", "null"] },
        "item": { "type": ["string", "null"] }
      }
    },
    "ComplianceLogic": {
      "type": "object",
      "description": "適合判定ロジック",
      "properties": {
        "scope_condition": { "type": "object" },
        "judgment_rule": { "type": "object" },
        "exceptions": { "type": ["object", "null"] }
      }
    },
    "FlowDiagramInfo": {
      "type": "object",
      "description": "フロー図の本体",
      "required": ["nodes", "edges"],
      "properties": {
        "title": {
          "type": "string",
          "description": "フロー図のタイトル"
        },
        "description": {
          "type": "string",
          "description": "フロー図の説明"
        },
        "nodes": {
          "type": "array",
          "description": "フロー図のノード一覧",
          "items": {
            "oneOf": [
              { "$ref": "#/definitions/TerminalNode" },
              { "$ref": "#/definitions/DecisionNode" },
              { "$ref": "#/definitions/ProcessNode" },
              { "$ref": "#/definitions/InformationNode" }
            ]
          },
          "minItems": 2
        },
        "edges": {
          "type": "array",
          "description": "ノード間の接続",
          "items": { "$ref": "#/definitions/FlowEdge" },
          "minItems": 1
        }
      }
    },
    "TerminalNode": {
      "type": "object",
      "description": "開始・終了ノード（楕円形）",
      "required": ["id", "type", "title", "result"],
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string", "const": "terminal" },
        "title": { "type": "string" },
        "result": {
          "type": "string",
          "enum": ["start", "end", "pass", "fail"]
        },
        "description": { "type": "string" },
        "related_articles": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "DecisionNode": {
      "type": "object",
      "description": "条件分岐ノード（六角形/ひし形）。【重要】「〜を特定したか？」という分岐は禁止。特定した結果の値で分岐する。例: ×「構造を特定したか？」→○「構造種別は？」（木造/耐火/準耐火/その他）",
      "required": ["id", "type", "title"],
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string", "const": "decision" },
        "title": {
          "type": "string",
          "description": "分岐条件。【禁止】「〜を特定したか？」「〜の確認」形式。【推奨】「〜は？」（値の列挙で多方向分岐）または「〜か？」（真偽判定でyes/no分岐）"
        },
        "decision_type": {
          "type": "string",
          "description": "分岐タイプ。binary: 真偽(yes/no)、multi: 値による多方向分岐",
          "enum": ["binary", "multi"],
          "default": "binary"
        },
        "options": {
          "type": "array",
          "description": "decision_type=multiの場合の選択肢一覧。エッジのlabelと対応する。",
          "items": {
            "type": "object",
            "properties": {
              "value": { "type": "string", "description": "選択肢の値（エッジのlabelに使用）" },
              "description": { "type": "string", "description": "選択肢の説明" }
            },
            "required": ["value"]
          }
        },
        "description": { "type": "string" },
        "condition": { "$ref": "#/definitions/Condition" },
        "related_articles": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "ProcessNode": {
      "type": "object",
      "description": "処理ノード（角丸矩形）",
      "required": ["id", "type", "title"],
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string", "const": "process" },
        "title": { "type": "string" },
        "process_type": {
          "type": "string",
          "enum": ["mechanical", "human_judgment", "consistency_check", "sub_diagram_reference", "undefined_input"],
          "default": "mechanical"
        },
        "description": { "type": "string" },
        "related_articles": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "InformationNode": {
      "type": "object",
      "description": "情報ノード（矩形）",
      "required": ["id", "type", "title"],
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string", "const": "information" },
        "title": { "type": "string" },
        "symbol": { "type": "string" },
        "subject": { "type": "string" },
        "property": { "type": "string" },
        "property_type": {
          "type": "string",
          "enum": ["proposition", "classification", "numeric", "geometric_point", "geometric_direction", "geometric_line", "geometric_surface", "geometric_solid", "set_definition", "visual"]
        },
        "description": { "type": "string" },
        "related_articles": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "Condition": {
      "type": "object",
      "description": "判定条件",
      "properties": {
        "operator": {
          "type": "string",
          "enum": ["EQ", "NE", "GT", "GTE", "LT", "LTE", "IN", "NOT_IN"]
        },
        "lhs": {
          "type": "object",
          "properties": {
            "var": { "type": "string" },
            "desc": { "type": "string" }
          }
        },
        "rhs": {
          "type": "object",
          "properties": {
            "value": {},
            "var": { "type": "string" },
            "desc": { "type": "string" },
            "unit": { "type": "string" }
          }
        }
      }
    },
    "FlowEdge": {
      "type": "object",
      "description": "フロー図のエッジ（接続）。decision_type=multiの分岐では role=option を使い、labelに具体的な値を設定する。",
      "required": ["id", "from", "to"],
      "properties": {
        "id": { "type": "string" },
        "from": { "type": "string" },
        "to": { "type": "string" },
        "role": {
          "type": "string",
          "description": "エッジの役割。yes/no: binary分岐用。option: multi分岐用（labelに値を設定）。flow: 通常の接続。",
          "enum": ["yes", "no", "option", "flow", "input", "output", "primary", "supporting"]
        },
        "label": {
          "type": "string",
          "description": "エッジのラベル。role=optionの場合は分岐値（例: 木造、耐火構造、準耐火構造）を設定"
        }
      }
    },
    "RelatedLaw": {
      "type": "object",
      "required": ["law_id", "law_name", "law_type", "relationship"],
      "properties": {
        "law_id": { "type": "string" },
        "law_name": { "type": "string" },
        "law_type": {
          "type": "string",
          "enum": ["act", "order", "regulation", "notice"]
        },
        "relationship": {
          "type": "string",
          "enum": ["delegates_to", "delegated_from", "defines_detail", "references", "supersedes"]
        },
        "articles": {
          "type": "array",
          "items": { "type": "string" }
        },
        "description": { "type": "string" }
      }
    },
    "DiagramMetadata": {
      "type": "object",
      "properties": {
        "created_at": { "type": "string" },
        "updated_at": { "type": "string" },
        "author": { "type": "string" },
        "generator": { "type": "string" },
        "law_id": { "type": "string" },
        "law_name": { "type": "string" },
        "checklist_ref": { "type": "string" }
      }
    }
  }
}
